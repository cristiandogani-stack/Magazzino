<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Accesso</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Foglio di stile personalizzato: include i nuovi font e le regole comuni -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            /* Colore di sfondo coerente con l'applicazione */
            background-color: #f7f9fc;
            min-height: 100vh;
        }
        .login-container {
            max-width: 420px;
        }
        .logo-container img {
            max-width: 200px;
        }
        /* Titolo sotto il logo nella pagina di accesso.  Utilizziamo un font
           leggermente più grande e un peso medio per armonizzarsi con il
           resto dell'interfaccia. Il colore richiama l'header dell'app. */
        .logo-title {
            font-size: 1.7rem;
            font-weight: 600;
            color: #274690;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- Logo tondo in alto -->
        <div class="d-flex justify-content-center mb-4 logo-container flex-column align-items-center">
            <!-- Immagine del logo tondo -->
            <img src="{{ url_for('static', filename='solo_tondi.png') }}" alt="Logo Tondi">
            <!-- Testo "Magazzino" sotto l'immagine -->
            <div class="logo-title mt-2">Magazzino</div>
        </div>
        <div class="mx-auto login-container">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">Accesso</h5>
                    <form method="post">
                        <div class="mb-3">
                            <label for="username" class="form-label">Utente</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <!-- Pulsante per salvare le credenziali sul dispositivo -->
                        <div class="mb-3">
                            <!-- Il pulsante ha type="button" per evitare l'invio del form. -->
                            <button type="button" id="saveCredentials" class="btn btn-secondary w-100">Salva credenziali</button>
                        </div>
                        <!-- Messaggi flash -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                        {% endwith %}
                        <button type="submit" class="btn btn-primary w-100">Entra</button>
                        <!-- Contenitore dove compariranno le credenziali salvate -->
                        <div id="savedCredentialsContainer" class="mt-3"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script per gestire il salvataggio delle credenziali nel dispositivo tramite un pulsante.
         Quando l'utente clicca su "Salva credenziali" vengono memorizzati
         utente e password in localStorage in un array di credenziali.  Al
         caricamento della pagina vengono visualizzate le credenziali salvate
         sotto forma di box cliccabili.  Cliccando su uno di questi box
         verranno precompilati i campi del form e inviato automaticamente il
         modulo di accesso.  Questo comportamento è completamente lato
         client e non influisce sul server Flask. -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const saveButton = document.getElementById('saveCredentials');
        const savedContainer = document.getElementById('savedCredentialsContainer');
        const form = document.querySelector('form');

        /**
         * Recupera l'array di credenziali salvate da localStorage.
         * @returns {Array<{username: string, password: string}>}
         */
        function getSavedCredentials() {
          try {
            const data = localStorage.getItem('saved_credentials');
            return data ? JSON.parse(data) : [];
          } catch (e) {
            console.error('Errore nel parse delle credenziali salvate', e);
            return [];
          }
        }

        /**
         * Salva l'array di credenziali in localStorage.
         * @param {Array<{username: string, password: string}>} creds
         */
        function setSavedCredentials(creds) {
          localStorage.setItem('saved_credentials', JSON.stringify(creds));
        }

        /**
         * Aggiorna la lista visuale dei box con le credenziali salvate.
         */
        function renderSavedCredentials() {
          const creds = getSavedCredentials();
          savedContainer.innerHTML = '';
          if (creds.length > 0) {
            // Creiamo un elemento wrapper per migliorare il layout
            const list = document.createElement('div');
            list.className = 'list-group';
            creds.forEach((cred, index) => {
              const item = document.createElement('button');
              item.type = 'button';
              item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
              item.textContent = cred.username;
              // Memorizziamo l'indice per recuperare la password all'occorrenza
              item.dataset.index = index;
              item.addEventListener('click', function () {
                const idx = parseInt(this.dataset.index, 10);
                const stored = getSavedCredentials()[idx];
                if (stored) {
                  usernameInput.value = stored.username;
                  passwordInput.value = stored.password;
                  // Invia il form automaticamente per l'accesso rapido
                  form.submit();
                }
              });
              list.appendChild(item);
            });
            // Aggiungiamo un titolo per chiarezza
            const header = document.createElement('div');
            header.className = 'fw-semibold mb-2';
            header.textContent = 'Credenziali salvate:';
            savedContainer.appendChild(header);
            savedContainer.appendChild(list);
          }
        }

        // Renderizza subito i box all'avvio
        renderSavedCredentials();

        // Gestisce il click sul pulsante di salvataggio
        saveButton.addEventListener('click', function () {
          const user = usernameInput.value.trim();
          const pass = passwordInput.value;
          if (!user || !pass) {
            // Richiediamo all'utente di inserire entrambi i campi
            alert('Inserisci sia utente che password per salvare le credenziali.');
            return;
          }
          let creds = getSavedCredentials();
          // Verifichiamo se esiste già un record per lo stesso utente; in tal caso aggiornamento
          const existingIndex = creds.findIndex(c => c.username === user);
          if (existingIndex >= 0) {
            creds[existingIndex] = { username: user, password: pass };
          } else {
            creds.push({ username: user, password: pass });
          }
          setSavedCredentials(creds);
          renderSavedCredentials();
        });
      });
    </script>
</body>
</html>